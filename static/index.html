<html>

<title>ServiceChecker</title>

<head>
    <link rel="stylesheet" href="style.css">
    <link id="icon" rel="shortcut icon" type="image/x-icon" href="green.png">
</head>


<script>

    setInterval(function () {
        update();
    }, 5000);

    function update() {

        httpGetAsync("/api/states", function (response) {
            draw(JSON.parse(response))
        },
            function (error) {

                // create header
                var header = document.createElement("div");
                header.classList.add("flex");
                let kachel = document.createElement("div");
                kachel.classList.add("kachel");
                kachel.classList.add("kachelNOk");
                kachel.classList.add("headerKachel");
                kachel.append(document.createTextNode("ServiceMonitor returns an error"));
                header.append(kachel);


                var baseDiv = document.getElementById('data');
                baseDiv.innerHTML = '';

                baseDiv.append(header);
            });
    }
    update();

    function draw(data) {

        data.sort(function (a, b) {
            if (a.Ok == b.Ok) {
                return a.Name.localeCompare(b.Name);
            }

            if (!a.Ok) {
                return -1;
            }

            return 1;
        });

        var holder = document.createElement("div");
        holder.classList.add("flex");


        let services = 0;
        let servicesOk = 0;
        let servicesNok = 0;

        for (const service of data) {

            // create Kachel
            const kachel = document.createElement("div");
            kachel.classList.add("kachel");
            if (service.Ok) {
                kachel.classList.add("kachelOk");
                servicesOk++;
            } else {
                kachel.classList.add("kachelNOk");
                servicesNok++;
            }
            services++;

            kachel.setAttribute('title', service.Service + ' \n HTTP-Code: ' + service.HTTPCode + ' \n Body: ' + service.Response);

            let row = document.createElement("div");

            let serviceName = service.Name
            if (serviceName == '') {
                serviceName = service.Service
            }

            row.append(document.createTextNode(serviceName));
            kachel.append(row);

            row = document.createElement("div");
            row.append(document.createTextNode("Fehler: " + service.ErrorCount));
            kachel.append(row);

            row = document.createElement("div");
            row.append(document.createTextNode("Last Ok: " + new Date(service.LastOk).toLocaleString("de-DE")));
            kachel.append(row);


            holder.append(kachel);
        }


        // create header
        var header = document.createElement("div");
        header.classList.add("flex");
        let kachel = null;

        if (servicesOk != 0) {
            kachel = document.createElement("div");
            kachel.classList.add("kachel");
            kachel.classList.add("kachelOk");
            kachel.classList.add("headerKachel");
            kachel.append(document.createTextNode(servicesOk + "/" + services));
            header.append(kachel);
        }

        if (servicesNok != 0) {
            kachel = document.createElement("div");
            kachel.classList.add("kachel");
            kachel.classList.add("kachelNOk");
            kachel.classList.add("headerKachel");
            kachel.append(document.createTextNode(servicesNok + "/" + services));
            header.append(kachel);
            document.getElementById('icon').setAttribute("href", "red.png");
        }
        else {
            document.getElementById('icon').setAttribute("href", "green.png");
        }

        var baseDiv = document.getElementById('data');
        baseDiv.innerHTML = '';

        baseDiv.append(header);
        baseDiv.append(holder);
    }

    function httpGetAsync(theUrl, callback, error) {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.onreadystatechange = function () {
            if (xmlHttp.readyState == 4 && xmlHttp.status == 200) {
                callback(xmlHttp.responseText);
            }
        }
        xmlHttp.onerror = error
        xmlHttp.open("GET", theUrl, true); // true for asynchronous 
        xmlHttp.send(null);
    }

</script>


<body>

    <div id="data">

        <div>No Data</div>

    </div>
</body>


</html>